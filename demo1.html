<!DOCTYPE HTML>
<!--
	Verti by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>SSL</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
	</head>
	<body class="is-preload homepage">
		<div id="page-wrapper">

			<!-- Header -->
				<div id="header-wrapper" style="background-color: white;">
					<header id="header" class="container">

						<!-- Logo -->
							<div id="logo">
								<h1><a href="index2.html" style="background-color: white;"><strong style="color:#002178">SSL</strong></a></h1>
							</div>

						<!-- Nav -->
							<nav id="nav">
								<ul>
									<li><a href="index2.html">과제 개요</a></li>
									<li class="current">
										<a href="demo1.html">통합시연</a>
										<ul>
											<li><a href="demo1-12.html">Part 1</a></li>
											<li><a href="demo1-12.html#box2">Part 2</a></li>
											<li><a href="demo1-3.html">Part 3</a></li>
											<li><a href="demo1-4.html">Part 4</a></li>
										</ul>
									</li>
									<li>
										<a href="opensource.html">오픈소스</a>
										<ul>
											<li><a href="opensource.html">데이터셋</a></li>
											<li><a href="opensource2.html">Downstream Task</a></li>
										</ul>
									</li>
									<li><a href="contact.html">CONTACT</a></li>
								</ul>
							</nav>

					</header>
				</div>

			<!-- Main -->
			<div id="main-wrapper" style="background-color: white;">
				<div id="box-all" class="container" style="text-align: center;">
					<br/><br/>
					<h2 style="text-align: center; font-weight: 130; margin-bottom: 0.8em;">통합시연</h2>
					<hr color="black" width="10%" size="4px">
					<br/><br/>
					<div>
						<a href="demo1-12.html"><img src="images/home_1.png" onmouseover="this.src='images/home_1_fade.png'" onmouseout="this.src='images/home_1.png'" style="width: 25.33%; vertical-align: top;"></a><a href="demo1-3.html"><img src="images/home_2.png" onmouseover="this.src='images/home_2_fade.png'" onmouseout="this.src='images/home_2.png'" style="width: 46.74%; vertical-align: top;"></a><a href="demo1-4.html"><img src="images/home_3.png"  onmouseover="this.src='images/home_3_fade.png'" onmouseout="this.src='images/home_3.png'" style="width: 27.93%; vertical-align: top;"></a>
					</div>
					<br/>
					<hr style="height:10px; background-color:gray;">
					<br/><br/>
					<div class="row">
						<div class="col-3 col-12-medium">
							<h3>Part1</h3>
							이미지로부터 장면그래프 추출
							<div id="part1_labels" style="visibility: hidden;">
								<label>
									<input type="radio" name="part1" value="part1_POSTECH" checked="checked" />
									<span>POSTECH</span>
								</label><br/>
								<label>
									<input type="radio" name="part1" value="part1_KETI"/>
									<span>KETI</span>
								</label>
							</div>
						</div>
						<div class="col-3 col-12-medium">
							<h3>Part2</h3>
							추출된 장면그래프에 속성 추가
							<div id="part2_labels" style="visibility: hidden;">
								<label>
									<input type="radio" name="part2" value="part2_UNIST" checked="checked" />
									<span>UNIST</span>
								</label><br/>
								<label>
									<input type="radio" name="part2" value="part2_Birmingham" disabled />
									<span>Birmingham</span>
								</label>
							</div>
						</div>
						<div class="col-3 col-12-medium">
							<h3>Part3</h3>
							보이지 않는 부분을 시각적 상식으로 <br/>추론하여 장면그래프 복원
							<div id="part3_labels" style="visibility: hidden;">
								<label>
									<input type="radio" name="part3" value="part3_KAIST" checked="checked" />
									<span>KAIST</span>
								</label><br/>
								<label>
									<input type="radio" name="part3" value="part3_KETI" disabled />
									<span>KETI</span>
								</label><br/>
							</div>
						</div>
						<div class="col-3 col-12-medium">
							<h3>Part4</h3>
							장면그래프를 통하여 이미지 복원
							<div id="part4_labels" style="visibility: hidden;">
								<label>
									<input type="radio" name="part4" value="part4_KETI"/>
									<span>KETI</span>
								</label><br/>
								<label>
									<input type="radio" name="part4" value="part4_SNU" />
									<span>SNU</span>
								</label><br/>
								<label>
									<input type="radio" name="part4" value="part4_POSTECH" checked="checked"/>
									<span>POSTECH</span>
								</label>
							</div>
						</div>
					</div>
					<br/>
					<strong>이미지 파일 : &nbsp;&nbsp;&nbsp;</strong>
					<input type="file" id="file_img" accept="image/*" onchange="setImageThumbnail(event, '#image_container');"/>
					<br/>
					<strong>마스크 파일 : &nbsp;&nbsp;&nbsp;</strong>
					<input type="file" id="file_mask" accept="image/*" onchange="setImageThumbnail(event, '#mask_container');"/>
					<br/><br/>
					<div class="row">
						<div class="column">
							이미지
							<div id="image_container"><img src="examples/2023/demo_samples/594/594_masked.jpg" style="max-width:100%;"></div>
						</div>
						<div class="column">
							마스크
							<div id="mask_container"><img src="examples/2023/demo_samples/594/594_mask.png" style="max-width:100%;"></div>
						</div>
					</div>
					<br/><br/>
					<button onclick="submitData(event)" style="width: 95%; background-color: #002178;">통합 시연</button>		
					<br/><br/><br/>
					<div id="caption1" style="visibility: hidden;"><h3>Part1 결과</h3></div>
					<div id="image_result1"></div> 
					<pre id="json_result1" style="max-height: 20em; visibility: hidden;">json results</pre><br/>
					<div style="width: 100%; height: 600px;">
						<div id="part1_left" style="width: 33%; float: left;"></div>
						<div style="width: 66%; float: right; text-align: right;"><canvas id="json_canvas_result1" width="200" height="600"></canvas></div>
					</div>
					<br/><br/>

					<div id="caption2" style="visibility: hidden;"><h3>Part2 결과</h3></div>
					<pre id="json_result2" style="max-height: 20em; visibility: hidden;">json results</pre><br/>
					<div style="width: 100%; height: 600px;">
						<div id="part2_left" style="width: 33%; float: left;"></div>
						<div style="width: 66%; float: right; text-align: right;"><canvas id="json_canvas_result2" width="200" height="600"></canvas></div>
					</div>
					<br/><br/>

					<div id="caption3" style="visibility: hidden;"><h3>Part3 결과</h3></div>
					<pre id="json_result3" style="max-height: 20em; visibility: hidden;">json results</pre><br/>
					<div style="width: 100%; height: 600px;">
						<div id="part3_left" style="width: 33%; float: left;"></div>
						<div style="width: 66%; float: right; text-align: right;"><canvas id="json_canvas_result3" width="200" height="600"></canvas></div>
					</div>
					<br/><br/>

					<div id="caption4" style="visibility: hidden;"><h3>Part4 결과</h3></div>
					<div id="image_result4"></div> 
				</div>
			</div>

			<script>
				var in_process = false;
				var sysObj = {'sys1_output': '', 'sys2_input': '', 'sys2_output': '', 
							'sys3_input': '', 'sys3_output': '', 'sys4_input': ''};
				
				window.onload = function() {
					container = document.getElementById("box-all");

					json_canvas_result1 = document.getElementById("json_canvas_result1");
					json_canvas_result2 = document.getElementById("json_canvas_result2");
					json_canvas_result3 = document.getElementById("json_canvas_result3");
					json_canvas_result1.width = container.clientWidth * 0.6;
					json_canvas_result2.width = container.clientWidth * 0.6;
					json_canvas_result3.width = container.clientWidth * 0.6;
				}

				function hidePreviousResults() {
					$('#image_result2').html("");
					$('#json_result3').html("");
					$('#image_result4').html("");
					document.getElementById('json_result1').style.visibility = 'hidden';
					document.getElementById('json_result2').style.visibility = 'hidden';
					document.getElementById('json_result3').style.visibility = 'hidden';
					document.getElementById('caption1').style.visibility = 'hidden';
					document.getElementById('caption2').style.visibility = 'hidden';
					document.getElementById('caption3').style.visibility = 'hidden';
					document.getElementById('caption4').style.visibility = 'hidden';

					$('#part1_left').html("");
					$('#part2_left').html("");
					$('#part3_left').html("");
				}

				function submitData(event) {
					var readerImg = new FileReader();
					var readerMask = new FileReader();
					
					var checked_radios = [];
					for(var i = 1; i <= 4; i++) {
						var radio = document.getElementsByName('part'+i);
						var selected = Array.from(radio).find(radio => radio.checked).value;
						checked_radios.push(selected)
					}

					var file_check_img = $("#file_img").val();
					var file_check_mask = $("#file_mask").val();
					// 파일을 넣지 않을 경우
					if(!file_check_img && !file_check_mask) {
						getBase64ImageFromURL(input_url, checked_radios);
					}
					else if (file_check_img && file_check_mask) {
						var img = document.getElementById("file_img").files[0];
						readerImg.readAsDataURL(img);

						var mask = document.getElementById("file_mask").files[0];
						readerMask.readAsDataURL(mask);

						var imageLoadCount = 0
						var jsonArray = new Object();
						var base64image = null;
						var base64mask = null;

						readerImg.onload = function() {
							base64image = getBase64Image(readerImg);
							imageLoadCount += 1;
							if (imageLoadCount == 2) {
								jsonArray['image_contents'] = base64image;
								jsonArray['mask_contents'] = base64mask
								jsonArray = JSON.stringify(jsonArray);
								if (in_process) {
									alert("아직 이전 요청을 처리하고 있습니다.");
								}
								else {
									hidePreviousResults();
									postData(input_url, jsonArray, checked_radios, 1);
								}
							}
						}
						readerMask.onload = function() {
							base64mask = getBase64Image(readerMask);
							imageLoadCount += 1;
							if (imageLoadCount == 2) {
								jsonArray['image_contents'] = base64image;
								jsonArray['mask_contents'] = base64mask
								jsonArray = JSON.stringify(jsonArray);
								if (in_process) {
									alert("아직 이전 요청을 처리하고 있습니다.");
								}
								else {
									hidePreviousResults();
									postData(input_url, jsonArray, checked_radios, 1);
								}
							}
						}
					}
					else {
						if(!file_check_img) {
							alert("이미지를 선택하세요.");
						}
						if(!file_check_mask) {
							alert("마스크를 선택하세요.");
						}
					}
				}

				function getBase64ImageFromURL(input_url, checked_radios){
					var img = new Image();
					var mask = new Image();
					var imageLoadCount = 0
					var img_base64 = null;
					var img_mask = null;
					img.setAttribute('crossOrigin', 'anonymous');
					mask.setAttribute('crossOrigin', 'anonymous');
					
					var jsonArray = new Object();
					
					img.onload = imgData => {
						var canvas = document.createElement("canvas");
						canvas.width = img.width;
						canvas.height = img.height;
						var ctx = canvas.getContext("2d");
						ctx.drawImage(img, 0, 0);
						var dataURL = canvas.toDataURL("image/png");
						img_base64 = dataURL;
						var commaIndex = img_base64.indexOf(",");
						img_base64 = img_base64.slice(commaIndex+1);

						imageLoadCount += 1;
						if (imageLoadCount == 2) {
							jsonArray['image_contents'] = img_base64;
							jsonArray['mask_contents'] = img_mask;
							jsonArray = JSON.stringify(jsonArray);
							
							if (in_process) {
								alert("아직 이전 요청을 처리하고 있습니다.");
							}
							else {
								hidePreviousResults();
								postData(input_url, jsonArray, checked_radios, 1);
							}
						}
					}
					mask.onload = imgData => {
						var canvas2 = document.createElement("canvas");
						canvas2.width = mask.width;
						canvas2.height = mask.height;
						var ctx2 = canvas2.getContext("2d");
						ctx2.drawImage(mask, 0, 0);
						var dataURL_mask = canvas2.toDataURL("image/png");
						img_mask = dataURL_mask;
						var commaIndex = img_mask.indexOf(",");
						img_mask = img_mask.slice(commaIndex+1);

						imageLoadCount += 1;
						if (imageLoadCount == 2) {
							jsonArray['image_contents'] = img_base64;
							jsonArray['mask_contents'] = img_mask;
							jsonArray = JSON.stringify(jsonArray);
							
							if (in_process) {
								alert("아직 이전 요청을 처리하고 있습니다.");
							}
							else {
								hidePreviousResults();
								postData(input_url, jsonArray, checked_radios, 1);
							}
						}
					}
					img.src = 'examples/2023/demo_samples/594/594_masked.jpg';
					mask.src = 'examples/2023/demo_samples/594/594_mask.png';
				}

				function getBase64Image(reader) {
					var base64image = reader.result;
					var commaIndex = base64image.indexOf(",");
					base64image = base64image.slice(commaIndex+1);
					return base64image;
				}

				var $input_img = '';
				function postData(input_url, jsonArray, checked_radios, num) {
					if (num == 1) {
						in_process = true;
						$('#image_result1').html("loading...");
						for(var j = 1; j <= 3; j++) {
							clear_json_visualizer('sys'+j+'_output', '#json_canvas_result'+j);
						}
						$input_img = $("#image_container").children("img").clone();
					}
					$.ajax({
						type: "POST",
						url: input_url+checked_radios[num-1],
						data: jsonArray,
						success:function(data){
							$('#image_result1').html("");
							var obj = JSON.parse(data);
							if(num == 1 || num == 2 || num == 3) {
								$input_img_clone = $input_img.clone()
								$("#part"+num+"_left").append($input_img_clone);

								var outputSceneGraph = obj.scene_graph_json;
								outputSceneGraph['image_name'] = '1.jpg';
								document.getElementById('json_result'+num).style.visibility = 'visible';
								document.getElementById('caption'+num).style.visibility = 'visible';
								$('#json_result'+num).html(JSON.stringify(outputSceneGraph));
								visualize_json('sys'+num+'_output', JSON.stringify(outputSceneGraph), '#json_canvas_result'+num);
								
								jsonArray = JSON.parse(jsonArray);
								jsonArray['scene_graph'] = outputSceneGraph;
								jsonArray = JSON.stringify(jsonArray); // 'image_contents', 'mask_contents', 'scene_graph'
								postData(input_url, jsonArray, checked_radios, num+1);
							}
							else if(num == 4) { //Part4
								document.getElementById('caption4').style.visibility = 'visible';
								var inpaintResult = document.createElement("img");
								inpaintResult.setAttribute("src", 'data:image/png;base64,' + obj.image_contents); 
								inpaintResult.setAttribute("style", "max-width: 70%; height: auto;"); 
								$('#image_result4').html("");
								document.querySelector('#image_result4').appendChild(inpaintResult);
								in_process = false;
							}
						},
						error:function(data){
							in_process = false;
							$('#image_result1').html("");
							if(num == 1 || num == 2 || num == 3) {
								document.getElementById('json_result'+num).style.visibility = 'visible';
								document.getElementById('caption'+num).style.visibility = 'visible';
								$('#json_result'+num).html("Error occurred. Try again.");
							}
							else if(num == 4) {
								document.getElementById('caption4').style.visibility = 'visible';
								$('#image_result4').html("Error occurred. Try again.");
							}
							alert(JSON.stringify(data));
						}
					});
				}
			</script>

			<!-- Footer -->
			<div id="footer-wrapper">
				<footer id="footer" class="container">
					<div class="row">
						<div class="col-3 col-6-medium col-12-small">

							<!-- Links -->
								<section class="widget links">
									<h3><a href="index2.html">과제 개요</a></h3>
								</section>

						</div>
						<div class="col-3 col-6-medium col-12-small">

							<!-- Links -->
								<section class="widget links">
									<h3><a href="demo1.html">통합시연</a></h3>
									<ul class="style2">
										<li><a href="demo1-12.html">Part 1</a></li>
										<li><a href="demo1-12.html#box2">Part 2</a></li>
										<li><a href="demo1-3.html">Part 3</a></li>
										<li><a href="demo1-4.html">Part 4</a></li>
									</ul>
								</section>

						</div>
						<div class="col-3 col-6-medium col-12-small">

							<!-- Links -->
								<section class="widget links">
									<h3><a href="opensource.html">오픈소스</a></h3>
									<ul class="style2">
										<li><a href="opensource.html">데이터셋</a></li>
										<li><a href="opensource2.html">Downstream Task</a></li>
									</ul>
								</section>

						</div>
						<div class="col-3 col-6-medium col-12-small">

							<!-- Links -->
								<section class="widget links">
									<h3><a href="contact.html">CONTACT</a></h3>
								</section>

						</div>
					</div>
					<div class="row">
						<div class="col-12">
							<div id="copyright">
								<ul class="menu">
									<li>&copy; KETI. All rights reserved</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
								</ul>
							</div>
						</div>
					</div>
				</footer>
			</div>

			</div>

		<!-- Scripts -->

			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.dropotron.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			<script src="assets/js/arbor.js"></script>
			<script src="assets/js/graphics.js"></script>
			<script src="assets/js/renderer.js"></script>
			<script src="assets/js/thumbnail.js"></script>
			<script src="assets/js/main_connection_info.js"></script>
			<script src="assets/js/json_visualizer.js"></script>

	</body>
</html>
